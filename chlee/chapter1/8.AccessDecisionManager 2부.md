# USER ê¶Œí•œ ì¶”ê°€í•˜ê¸°

ìš°ì„  ì›¹í˜ì´ì§€ë¥¼ í•˜ë‚˜ ë” ë§Œë“¤ê² ìŠµë‹ˆë‹¤.

- user.html

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User</title>
</head>
<body>
<h1 th:text="${message}">User</h1>
</body>
</html>
```

ê·¸ë¦¬ê³  userì— ëŒ€í•œ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

- SampleController.java

```java
@GetMapping("/user")
public String user(Model model, Principal principal) {
    model.addAttribute("message", "Hello User, " + principal.getName());
    return "user";
}
```

ì´ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ADMINê³¼ëŠ” ë‹¬ë¦¬ USER ê¶Œí•œì„ ê°€ì§„ ê³„ì •ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹œíë¦¬í‹° ì„¤ì •ì—ë„ ì¶”ê°€í•´ì¤ì‹œë‹¤.

- SecurityConfig.java

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests()
            .mvcMatchers("/", "/info", "/account/**").permitAll()
            .mvcMatchers("/admin").hasRole("ADMIN")
            .mvcMatchers("/user").hasRole("USER")
            .anyRequest().authenticated();

    http.formLogin();
    http.httpBasic();
}
```

# AMDIN ê¶Œí•œìœ¼ë¡œ USER ê¶Œí•œì— ì ‘ê·¼í•˜ê¸°

ì¼ë°˜ì ìœ¼ë¡œ ADMIN ê¶Œí•œ ê³„ì •ë„ USERê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ëª¨ë“  í˜ì´ì§€ì—ëŠ” ì ‘ê·¼ì´ ê°€ëŠ¥í•´ì•¼í•©ë‹ˆë‹¤.

ê·¸ëŸ¼ ì‹¤í–‰ì„ í•´ì„œ í™•ì¸í•´ë´…ì‹œë‹¤.

ë¨¼ì € ADMIN ê³„ì •ì„ í•˜ë‚˜ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

- [http://localhost:8080/account/ADMIN/admin/123](http://localhost:8080/account/ADMIN/admin/123)

ê·¸ë¦¬ê³  ë§Œë“  ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê³  /user ê²½ë¡œì— ì ‘ê·¼ì„ í•´ë´…ì‹œë‹¤.

- [http://localhost:8080/user](http://localhost:8080/user)

ì•„ë˜ ì‚¬ì§„ì²˜ëŸ¼ ì ‘ê·¼ì´ ì•ˆë©ë‹ˆë‹¤.

![Untitled](https://user-images.githubusercontent.com/77683221/234140047-cbc94238-34eb-4589-bc23-be65aa891448.png)


ì™œëƒë©´ í˜„ì¬ ê³„ì •ì€ USERì— ëŒ€í•œ ê¶Œí•œì´ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ADMINì— ëŒ€í•œ ê¶Œí•œë§Œ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë¬´ìŠ¨ ë§ì¸ì§€ ì¢€ ë” ìì„¸í•˜ê²Œ ì‚´í´ë³´ê¸° ìœ„í•´ ì•ì—ì„œ ë§Œë“¤ì—ˆë˜ dashboard ì— ë””ë²„ê¹…ì„ í•´ë†“ê³  /dashboard ì— ì ‘ê·¼í•´ì„œ í™•ì¸í•´ë´…ì‹œë‹¤.

<img width="1008" alt="Untitled 1" src="https://user-images.githubusercontent.com/77683221/234140065-30c8e8ea-d619-46ed-9470-c0f0fa84f3b4.png">


<img width="748" alt="Untitled 2" src="https://user-images.githubusercontent.com/77683221/234140091-2bbce5ef-aee6-4625-99d2-94bc214e8c6b.png">


authorities ê°€ ROLE_ADMIN ë°–ì— ì—†ìŠµë‹ˆë‹¤. ì¦‰, ë°©ê¸ˆ ë§Œë“  ê³„ì •ì€ ADMIN ê¶Œí•œë°–ì— ì—†ë‹¤ëŠ” ê²ƒì´ì£ .

ê·¸ëŸ°ë° ìœ„ì—ì„œ ë§Œë“  ì‹œíë¦¬í‹° ì„¤ì •ì—ì„œ /user ì— ì ‘ê·¼í•˜ëŠ” ê¶Œí•œì„ USER ë¡œë§Œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‹ˆ ë§Œë“  ê³„ì •ìœ¼ë¡œ /userì— ì ‘ê·¼ì„ í•˜ë©´ Forbidden ì—ëŸ¬í˜ì´ì§€ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” ADMINì´ ë¬´ìŠ¨ ëœ»ì¸ì§€, USERê°€ ë¬´ìŠ¨ ëœ»ì¸ì§€ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” ë‹¨ì–´ë§Œ ë³´ë©´ ADMINì´ USER ê¶Œí•œì„ í¬í•¨í•˜ê³  ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆì§€ë§Œ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” ì˜ë¯¸ê¹Œì§€ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‹ˆ ê¸°ëŒ€í–ˆë˜ëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ”ê²Œ ë‹¹ì—°í•œê±°ì£ .

# í•´ê²° ë°©ë²• 2ê°€ì§€

## 1. AccountService ì—ì„œ ADMIN ê¶Œí•œì¼ ê²½ìš° USERì— ëŒ€í•œ ê¶Œí•œê¹Œì§€ ë„˜ê²¨ì£¼ê¸°

- AccountService

```java
@Override
public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
    Account account = accountRepository.findByUsername(username);
    if (account == null) {
        throw new UsernameNotFoundException(username);
    }

    return User.builder()
            .username(account.getUsername())
            .password(account.getPassword())
            **.roles(account.getRole(), "USER") //...1**
            .build();
}
```

1. ì •í™•í•˜ê²ŒëŠ” account.getRole() ì´ ADMINì¼ ë•Œ USERë¥¼ ì¶”ê°€í•´ì•¼ê² ì£ ?
    
    ìš°ì„  ì´ëŸ° ë°©ë²•ë„ ìˆë‹¤ëŠ” ê²ƒì„ ì„¤ëª…í•˜ê¸° ìœ„í•¨ì´ë¯€ë¡œ ê°„ë‹¨í•˜ê²Œ ì½”ë“œë¥¼ ì‘ì„±í•œ ê²ƒì…ë‹ˆë‹¤.
    

## 2. Role Hierarchy ì„¤ì •í•˜ê¸°

Role Hierarchy ë¥¼ ì´í•´í•˜ëŠ” AccessDecisionManager ë§Œë“¤ê³  í•´ë‹¹ AccessDecisionManagerë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•´ë³´ê² ìŠµë‹ˆë‹¤.

- SecurityConfig

```java
@Configuration
@EnableWebSecurity
@Order(Ordered.LOWEST_PRECEDENCE - 100)
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    //...1
    public AccessDecisionManager accessDecisionManager() {
        RoleHierarchyImpl roleHierarchy = new RoleHierarchyImpl(); //...e
        roleHierarchy.setHierarchy("ROLE_ADMIN > ROLE_USER");

        DefaultWebSecurityExpressionHandler handler = new DefaultWebSecurityExpressionHandler(); //...d
        handler.setRoleHierarchy(roleHierarchy);

        WebExpressionVoter webExpressionVoter = new WebExpressionVoter(); //...c
        webExpressionVoter.setExpressionHandler(handler);

        List<AccessDecisionVoter<? extends Object>> voters = Arrays.asList(webExpressionVoter); //...b
        return new AffirmativeBased(voters); //...a
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .mvcMatchers("/", "/info", "/account/**").permitAll()
                .mvcMatchers("/admin").hasRole("ADMIN")
                .mvcMatchers("/user").hasRole("USER")
                .anyRequest().authenticated()
                .accessDecisionManager(accessDecisionManager()); //...2

        http.formLogin();
        http.httpBasic();
    }
}
```

1. AccessDecisionManager ë¥¼ ìƒˆë¡œ ì •ì˜í•©ë‹ˆë‹¤.
    1. AccessDecisionManager ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
        - ì›í•˜ëŠ” ê²ƒì€ Role Hierarchyë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ê·¸ëƒ¥ ê¸°ë³¸ ì „ëµì¸ AffirmativeBasedë¥¼ ë¦¬í„´í•´ ì¤„ ê²ƒì…ë‹ˆë‹¤.
        - AffirmativeBased ëŠ” ìƒì„±ì íŒŒë¼ë¯¸í„°ë¡œ voter ëª©ë¡ í•„ìš”í•©ë‹ˆë‹¤.
    2. voter ëª©ë¡ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
        - ì—¬ëŸ¬ê°œì˜ voter ëª©ë¡ì„ asList ë¡œ ì´ˆê¸°í™”í•´ì£¼ë©´ ë©ë‹ˆë‹¤.
    3. voter ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
        - ë§ˆì°¬ê°€ì§€ë¡œ ì›í•˜ëŠ” ê²ƒì€ Role Hierarchy ë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ê¸°ë³¸ì ìœ¼ë¡œ ìˆëŠ” WebExpressionVoterë¥¼ ë§Œë“¤ ê²ƒ ì…ë‹ˆë‹¤.
    4. voter ëŠ” expressionHandler ë¥¼ ì‚¬ìš©í•˜ë‹ˆ expressionHandler ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
        - Role Hierarchy ë¥¼ ì„¤ì •í•˜ëŠ” ê³³ì´ ë°”ë¡œ expressionHandler ì…ë‹ˆë‹¤.
    5. í•¸ë“¤ëŸ¬ì— Role Hierarchy ì„¤ì •ì„ ë„£ì–´ì£¼ê¸° ìœ„í•´ Role Hierarchy ì„¤ì • ê°ì²´ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
        - `ROLE_ADMIN > ROLE_USER`
            - USER í•  ìˆ˜ ìˆëŠ”ê±´ ADMINì´ í•  ìˆ˜ ìˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.
2. accessDecisionManager()
    - ìƒˆë¡œ ì •ì˜í•œ AccessDecisionManager ë¥¼ ë„£ì–´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - accessDecisionManager ë©”ì†Œë“œë¥¼ ë”°ë¡œ ëª…ì‹œì ìœ¼ë¡œ ë„£ì–´ì£¼ì§€ ì•ŠëŠ”ë‹¤ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ AccessDecisionManager ë¥¼ ì“°ê²Œ ë©ë‹ˆë‹¤.
        
        ê¸°ë³¸ì ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ AccessDecisionManager ê°€ ë°”ë¡œ AffirmativeBased ì „ëµì…ë‹ˆë‹¤.
        

ì´ì œ ì‹¤í–‰ í›„ ADMIN ê¶Œí•œì˜ Accountë¥¼ ë§Œë“¤ê³ , /user ì— ì ‘ê·¼ì„ í•´ë´…ì‹œë‹¤.

![Untitled 3](https://user-images.githubusercontent.com/77683221/234140220-368600b4-c5f4-4ee9-93ae-07f3bd828a33.png)

ADMIN ê¶Œí•œì„ ê°€ì§„ ê³„ì •ì´ USER ê¶Œí•œì—ë„ ì ‘ê·¼ê°€ëŠ¥í•œ ê²ƒì„ ë³¼ ìˆ˜ ìˆì£ .

### ë” ê°„ë‹¨í•˜ê²Œ ì„¤ì •í•˜ëŠ” ë°©ë²•ì€ ì—†ì„ê¹Œ?

ì½”ë“œê°€ ì¢€ ë§ì´ ë³µì¡í•˜ë‹¤ê³  ëŠë‚„ ìˆ˜ ìˆëŠ”ë° ë‹¤ì‹œ ë³´ë©´ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë˜ ê²ƒë“¤ì„ í’€ì–´ì„œ ì“´ ê²ƒì…ë‹ˆë‹¤.

AccessDecisionManager ë„ ê¸°ë³¸ ì „ëµì¸ AffirmativeBased ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê³ ,

Voterë„ ê¸°ì¡´ AccessDecisionManager ì— í•˜ë‚˜ ë“¤ì–´ìˆë˜ Voter ì¸ WebExpressionVoter ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê³ ,

ExpressionHandler ë„ ë™ì¼í•œ ê²ƒì„ ì“°ê³  ìˆìŠµë‹ˆë‹¤.

ë‹¨ì§€ í•¸ë“¤ëŸ¬ì—ë‹¤ê°€ Role Hierarchy ì„¤ì •ë§Œ ì¶”ê°€í–ˆì„ ë¿ì´ì£ .

ë‹¤ë¥¸ ì‹œíë¦¬í‹° ì„¤ì •ì€ í¸í•˜ê²Œ ì œê³µí•´ì£¼ëŠ”ê²Œ ë§ì€ë° Role Hierarchy í•˜ë‚˜ë§Œ ì„¤ì •í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ì—†ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì½”ë“œê°€ ì¥í™©í•´ì§„ ê²ƒì´ì£ .

ê·¸ë ‡ì§€ë§Œ ì¡°ê¸ˆ ê°„ë‹¨í•˜ê²Œ ì»¤ìŠ¤í…€í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

AccessDecisionManager ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ExpressionHandler ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

```java
@Configuration
@EnableWebSecurity
@Order(Ordered.LOWEST_PRECEDENCE - 100)
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    public SecurityExpressionHandler expressionHandler() {
        RoleHierarchyImpl roleHierarchy = new RoleHierarchyImpl();
        roleHierarchy.setHierarchy("ROLE_ADMIN > ROLE_USER");

        DefaultWebSecurityExpressionHandler handler = new DefaultWebSecurityExpressionHandler();
        handler.setRoleHierarchy(roleHierarchy);

        return handler;
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .mvcMatchers("/", "/info", "/account/**").permitAll()
                .mvcMatchers("/admin").hasRole("ADMIN")
                .mvcMatchers("/user").hasRole("USER")
                .anyRequest().authenticated()
                .expressionHandler(expressionHandler());

        http.formLogin();
        http.httpBasic();
    }
```

ì´ë²ˆì—ëŠ” AccessDecisionManager ìì²´ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•œê²Œ ì•„ë‹ˆë¼ AccessDecisionManager ì˜ Voter ê°€ ì‚¬ìš©í•˜ëŠ” ExpressionHandler ë§Œ ë°”ê¿” ë‚€ ê²ƒì…ë‹ˆë‹¤.

ì´ë ‡ê²Œ Role Hierarchy ì„¤ì •ì„ í•´ë´¤ìŠµë‹ˆë‹¤.

ì§€ê¸ˆê¹Œì§€ëŠ” AccessDecisionManager ì— ëŒ€í•´ì„œë§Œ ì‚´í´ë´¤ëŠ”ë° AccessDecisionManager ëŠ” ëˆ„ê°€, ì–¸ì œ í˜¸ì¶œí•˜ëŠ”ì§€ ì‚´í´ë³´ë„ë¡ í•˜ì£ .

AccessDecisionManager ë„ AuthenticationManager ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì–´ë””ì„ ê°€ ì‚¬ìš©ì´ ë˜ê² ì£ ?

<br>
<aside>
ğŸ“– [AuthenticationManager ë¦¬ë§ˆì¸ë“œ]

AuthenticationManager ëŠ” UsernamePasswordAuthenticationFilter ì—ì„œ ì‚¬ìš©í•´ì„œ ì¸ì¦ì„ í–ˆê³ , ì¸ì¦ëœ Authencation ê°ì²´ë¥¼ UsernamePasswordAuthenticationFilter ì—ì„œ SecurityContextHodler ì— ë„£ì–´ì¤¬ì£ .

SecurityContextPersisenceFilter ì—ì„œëŠ” HTTP sessionì— ìºì‹±ë˜ì–´ìˆë˜ SecurityContext ë¥¼ SecurityContextHodler ì—ë‹¤ê°€ ë„£ì–´ì¤¬ê³ , ìš”ì²­ ëë‚˜ë©´ ë¹„ì›Œì¤¬ì£ .

</aside>