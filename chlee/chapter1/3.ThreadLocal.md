ìŠ¤í”„ë§ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë¥¼ í•˜ê³  ìˆë‹¤ë©´ ThreadLocalë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ°ë° ì§ì ‘ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë…¸ì¶œì´ ë˜ì–´ìˆì§„ ì•ŠìŠµë‹ˆë‹¤.

ê·¸ë ‡ê²Œ ì–´ë ¤ìš´ ê°œë…ì€ ì•„ë‹ˆë‹ˆ ì‚´í´ë´…ì‹œë‹¤.

# **ThreadLocal**

í”„ë¡œê·¸ë˜ë°ì„ í•  ë•Œ ë³´í†µ ì–´ë–¤ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•˜ë©´ ê·¸ ë³€ìˆ˜ì—ëŠ” scopeì´ ì¡´ì¬í•©ë‹ˆë‹¤.

ThreadLocalì´ë€ ë³€ìˆ˜ë¥¼ ThreadLocal scopeì˜ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ë„ë¡ í•˜ëŠ” ì¥ì¹˜ì…ë‹ˆë‹¤.

í•œ ì“°ë ˆë“œ ë‚´ì—ì„œ ë³€ìˆ˜ í•˜ë‚˜ë¥¼ ê³µìœ í•˜ëŠ” ê²ƒê³¼ ë§ˆì°¬ê°€ì§€ ì…ë‹ˆë‹¤.

ê·¸ë˜ì„œ í”„ë¡œê·¸ë˜ë°ì´ í•œ ì“°ë ˆë“œ ë‚´ì—ì„œ ë™ì‘í•œë‹¤ë©´ ë©”ì†Œë“œ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì¤„ í•„ìš”ê°€ ì—†ê³  ThreadLocalì— ì¡´ì¬í•˜ë¯€ë¡œ ThreadLocalì— ë„£ê±°ë‚˜ ê°€ì ¸ì™€ì„œ ì“°ë©´ ë©ë‹ˆë‹¤.

<aside>
ğŸ“– [ì •ë¦¬] ThreadLocal ì´ë€?

Java.lang íŒ¨í‚¤ì§€ì—ì„œ ì œê³µí•˜ëŠ” ì“°ë ˆë“œ ë²”ìœ„ ë³€ìˆ˜. ì¦‰, ì“°ë ˆë“œ ìˆ˜ì¤€ì˜ ë°ì´í„° ì €ì¥ì†Œ.

- ê°™ì€ ì“°ë ˆë“œ ë‚´ì—ì„œë§Œ ê³µìœ .
- ë”°ë¼ì„œ ê°™ì€ ì“°ë ˆë“œë¼ë©´ í•´ë‹¹ ë°ì´í„°ë¥¼ ë©”ì†Œë“œ ë§¤ê°œë³€ìˆ˜ë¡œ ë„˜ê²¨ì¤„ í•„ìš” ì—†ìŒ.
- SecurityContextHolderì˜ ê¸°ë³¸ ì „ëµ.
</aside>

# ìë™ìœ¼ë¡œ ì ìš©ëœ **ThreadLocal**

ì´ì „ ì½”ë“œë¥¼ ë‹¤ì‹œ ë´…ì‹œë‹¤.

- SampleController

```java
@GetMapping("/dashboard")
public String dashboardV1(Model model, Principal principal) {
    model.addAttribute("message", "Hello, " + principal.getName());
    sampleService.dashboardV1();
    return "dashboard";
}
```

- SampleService

```java
@Service
public class SampleService {

    public void dashboardV1() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        Object principal = authentication.getPrincipal();
        Collection<? extends GrantedAuthority> authorities = authentication.getAuthorities();
        Object credentials = authentication.getCredentials();
        boolean authenticated = authentication.isAuthenticated();
    }
}
```

ì»¨íŠ¸ë¡¤ëŸ¬ì— ìˆëŠ” principalì— ëŒ€í•œ ì •ë³´ë¥¼ dashboardì—ì„œ SecurityContextHolderë¥¼ í†µí•´ì„œ ì°¸ì¡°í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° ì´ë ‡ê²Œ í•˜ì§€ ì•Šê³ , í•œ ì“°ë ˆë“œ ì•ˆì—ì„œ ê³µìœ í•˜ëŠ” í´ë˜ìŠ¤(ThreadLocal)ë¥¼ ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.

# ì§ì ‘ ì½”ë“œë¡œ **ThreadLocal ì ìš©í•´ë³´ê¸°**

## AccountContext

```java
package hello.springsecurityform.account;

public class AccountContext {

		//...1
    private static final ThreadLocal<Account> ACCOUNT_THREAD_LOCAL
            = new ThreadLocal<>();

		//...2
    public static void setAccount(Account account) {
        ACCOUNT_THREAD_LOCAL.set(account);
    }

		//...3
    public static Account getAccount() {
        return ACCOUNT_THREAD_LOCAL.get();
    }

}
```

1. Accountë¥¼ ì €ì¥í•  ìˆ˜ ìˆëŠ” ThreadLocalì„ ë§Œë“­ë‹ˆë‹¤.
2. Accountë¥¼ ë°›ì•„ì„œ ThreadLocal ì•ˆì—ë‹¤ê°€ ë„£ì–´ë‘˜ ìˆ˜ ìˆë„ë¡ setter ìƒì„±
3. ThreadLocal ì—ì„œ êº¼ë‚´ì„œ ì“¸ ìˆ˜ ìˆë„ë¡ getter ìƒì„±

## SampleController

```java
package hello.springsecurityform.form;

import hello.springsecurityform.account.AccountContext;
import hello.springsecurityform.account.AccountRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import java.security.Principal;

@Controller
public class SampleController {

    @Autowired SampleService sampleService;

    **@Autowired AccountRepository accountRepository; //...2**

    @GetMapping("/")
    public String index(Model model, Principal principal) {
        if (principal == null) {
            model.addAttribute("message", "Hello Spring Security");
        } else {
            model.addAttribute("message", "Hello, " + principal.getName());
        }
        return "index";
    }

    @GetMapping("/info")
    public String info(Model model) {
        model.addAttribute("message", "Info");
        return "info";
    }

    **@GetMapping("/dashboard")
    public String dashboardV2(Model model, Principal principal) {
        model.addAttribute("message", "Hello, " + principal.getName());
				//...1
        AccountContext.setAccount(accountRepository.findByUsername(principal.getName()));
        sampleService.dashboardV2();
        return "dashboard";
    }**

    @GetMapping("/admin")
    public String admin(Model model, Principal principal) {
        model.addAttribute("message", "Hello Admin, " + principal.getName());
        return "admin";
    }
}
```

1. AccountContext.setAccount(accountRepository.findByUsername(principal.getName()));
    - AccountContext ë¼ëŠ” ThreadLocalì„ ì‚¬ìš©í•˜ëŠ” ìœ í‹¸ë¦¬í‹°ì„± í´ë˜ìŠ¤ë¥¼ í•˜ë‚˜ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
    - ì´ì œ AccountContext ì—ë‹¤ê°€ Accountë¥¼ ë„£ì–´ë‘¡ì‹œë‹¤.
2. Accountë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´ accountRepositoryë¥¼ ì£¼ì…ë°›ì•„ì„œ findByUsernameë¡œ êº¼ë‚´ì™€ì•¼ í•©ë‹ˆë‹¤.

## SampleService

```java
package hello.springsecurityform.form;

import hello.springsecurityform.account.Account;
import hello.springsecurityform.account.AccountContext;
import org.springframework.stereotype.Service;

@Service
public class SampleService {

    public void dashboardV2() {
        Account account = AccountContext.getAccount();
        System.out.println("=============");
        System.out.println(account.getUsername());
    }
}
```

1. íŒŒë¼ë¯¸í„°ë¡œ ë°›ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
    
    ë˜í•œ SecurityContextHolderì—ì„œ êº¼ë‚¸ ê²ƒ ì²˜ëŸ¼ ë¹„ìŠ·í•˜ê²Œ Account ì •ë³´ë¥¼ êº¼ë‚´ì„œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    

ë§Œë“¤ì–´ë³¸ ì˜ˆì œ ì½”ë“œëŠ” SampleControllerì—ì„œ ìš°ë¦¬ê°€ ì ì ‘ ThreadLocalì— ë„£ì–´ì¤¬ì§€ë§Œ,

ì‹¤ì œë¡œëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì•Œì•„ì„œ ì¸ì¦ëœ ê°ì²´ë¥¼ ë„£ì–´ì¤ë‹ˆë‹¤. SecurityContextHolderì˜ ê¸°ë³¸ ì „ëµì´ ThreadLocal ì „ëµì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ì‹¤í–‰ì„ í•´ì„œ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•´ë´…ì‹œë‹¤.

![Untitled](%5B%E1%84%89%E1%85%B3%E1%84%91%E1%85%B3%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%8F%E1%85%B2%E1%84%85%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%8B%E1%85%A1%E1%84%8F%E1%85%B5%E1%84%90%E1%85%A6%E1%86%A8%E1%84%8E%E1%85%A5%5D%20ThreadLocal%20b783ab2d110945e1a4bdc58f4695ef80/Untitled.png)

ì ‘ì†ì„ í•˜ë©´ ì¶œë ¥ì´ ì œëŒ€ë¡œ ë©ë‹ˆë‹¤.

helloì— ëŒ€í•œ Account ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ThreadLocalì— ë„£ì–´ì¤¬ê³ , Service ë‹¨ì—ì„œëŠ” íŒŒë¼ë¯¸í„°ë¡œ ë°›ì§€ ì•Šê³  

ThreadLocalì—ì„œ êº¼ë‚´ì„œ ì“´ ê²ƒ ì…ë‹ˆë‹¤.

ê³„ì •ì„ í•˜ë‚˜ ë” ë§Œë“¤ì–´ë´…ì‹œë‹¤.

![Untitled](%5B%E1%84%89%E1%85%B3%E1%84%91%E1%85%B3%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%8F%E1%85%B2%E1%84%85%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%8B%E1%85%A1%E1%84%8F%E1%85%B5%E1%84%90%E1%85%A6%E1%86%A8%E1%84%8E%E1%85%A5%5D%20ThreadLocal%20b783ab2d110945e1a4bdc58f4695ef80/Untitled%201.png)

adminì´ ë“¤ì–´ìˆëŠ” ThreadLocal  ë”°ë¡œ , helloì´ ë“¤ì–´ìˆëŠ” ThreadLocal ë”°ë¡œ ê°€ì§€ê³  ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.z